schema: '2.0'
stages:
  parse_pdb@train:
    cmd: python src/parse_pdb.py --pdb_dir ../data/train --split train 
      --output_fasta output/train_data/train.fasta --output_parquet 
      output/train_data/train.parquet
    deps:
    - path: ../data/train
      hash: md5
      md5: 74273339a4952e0fd46387de3f67aee8.dir
      size: 8224991748
      nfiles: 15000
    - path: src/parse_pdb.py
      hash: md5
      md5: 745f7312c742b2a62ded281315fa254c
      size: 4700
    outs:
    - path: output/train_data/train.fasta
      hash: md5
      md5: 6bfd5e595023b90c4659e94a0badf7bb
      size: 7684601
    - path: output/train_data/train.parquet
      hash: md5
      md5: 776a0fc1b5477589ace417e2394dc8d0
      size: 145021981
  parse_pdb@test:
    cmd: python src/parse_pdb.py --pdb_dir ../data/test --split test 
      --output_fasta output/test_data/test.fasta --output_parquet 
      output/test_data/test.parquet
    deps:
    - path: ../data/test
      hash: md5
      md5: 51609831755873f0bb95e540f9b83b00.dir
      size: 270372087
      nfiles: 500
    - path: src/parse_pdb.py
      hash: md5
      md5: 745f7312c742b2a62ded281315fa254c
      size: 4700
    outs:
    - path: output/test_data/test.fasta
      hash: md5
      md5: db18eb34675132e9f3d8cead8fc6c271
      size: 267111
    - path: output/test_data/test.parquet
      hash: md5
      md5: dcb1f18bfa65103e9d65685c9369b02c
      size: 4696989
  mmseqs2:
    cmd: python src/run_mmseqs2.py --train_fasta 
      output/train_data/train_filtered.fasta --test_fasta 
      output/test_data/test_filtered.fasta --combined_fasta 
      output/mmseqs/all_seq.fasta --db_path output/mmseqs/all_seqs_db 
      --cluster_coverage 0.8 --cluster_min_seq_id 0.3 --cluster_tmp_dir /tmp 
      --cluster_output_tsv output/mmseqs/all_seqs_clust.tsv --search_coverage 
      0.8 --search_min_seq_id 0.3 --search_tmp_dir /tmp --search_output_tsv 
      output/mmseqs/all_seqs_similarity.tsv
    deps:
    - path: output/test_data/test_filtered.fasta
      hash: md5
      md5: a0924379fd4b7df8a0ea6648612393eb
      size: 266140
    - path: output/train_data/train_filtered.fasta
      hash: md5
      md5: 60a01e4680bcb43d281d4a2caa91d701
      size: 7613324
    - path: src/run_mmseqs2.py
      hash: md5
      md5: 1584491a261e1a3d1bd40df1f86985a2
      size: 4914
    outs:
    - path: output/mmseqs/all_seq.fasta
      hash: md5
      md5: 52b92ee0b9ee105eea12427280072dc1
      size: 7879464
    - path: output/mmseqs/all_seqs_clust.tsv
      hash: md5
      md5: d3e122bc224fdd80427217d4c2a6309b
      size: 671166
    - path: output/mmseqs/all_seqs_similarity.tsv
      hash: md5
      md5: 963c611fd1d45c3a7a12cd1919fa1207
      size: 27530359
  filter_sequences@train:
    cmd: python src/filter_sequences.py --input_parquet 
      output/train_data/train.parquet --input_fasta 
      output/train_data/train.fasta --output_parquet 
      output/train_data/train_filtered.parquet --output_fasta 
      output/train_data/train_filtered.fasta --min_length 30 --max_length 1000 
      --max_x_fraction 0.1 --max_b_factor 100.0
    deps:
    - path: output/train_data/train.fasta
      hash: md5
      md5: 6bfd5e595023b90c4659e94a0badf7bb
      size: 7684601
    - path: output/train_data/train.parquet
      hash: md5
      md5: 776a0fc1b5477589ace417e2394dc8d0
      size: 145021981
    - path: src/filter_sequences.py
      hash: md5
      md5: 9bb35855283c68b2ed61eb0299bdcee8
      size: 5576
    outs:
    - path: output/train_data/train_filtered.fasta
      hash: md5
      md5: 60a01e4680bcb43d281d4a2caa91d701
      size: 7613324
    - path: output/train_data/train_filtered.parquet
      hash: md5
      md5: fa0b6f9781754e248f76df564de64395
      size: 141102795
  filter_sequences@test:
    cmd: python src/filter_sequences.py --input_parquet 
      output/test_data/test.parquet --input_fasta output/test_data/test.fasta 
      --output_parquet output/test_data/test_filtered.parquet --output_fasta 
      output/test_data/test_filtered.fasta --min_length 30 --max_length 1000 
      --max_x_fraction 0.1 --max_b_factor 100.0
    deps:
    - path: output/test_data/test.fasta
      hash: md5
      md5: db18eb34675132e9f3d8cead8fc6c271
      size: 267111
    - path: output/test_data/test.parquet
      hash: md5
      md5: dcb1f18bfa65103e9d65685c9369b02c
      size: 4696989
    - path: src/filter_sequences.py
      hash: md5
      md5: 9bb35855283c68b2ed61eb0299bdcee8
      size: 5576
    outs:
    - path: output/test_data/test_filtered.fasta
      hash: md5
      md5: a0924379fd4b7df8a0ea6648612393eb
      size: 266140
    - path: output/test_data/test_filtered.parquet
      hash: md5
      md5: e94468c64a21000dbe2b4080ca8c8309
      size: 4577378
  prepare_dataset:
    cmd: python src/prepare_dataset.py --train_seq_path 
      output/train_data/train_filtered.parquet --test_seq_path 
      output/test_data/test_filtered.parquet --validation_pdbs_path 
      ../data/selected_validation_pdbs.json --output_train_path 
      output/datasets/train.pt --output_val_path output/datasets/val.pt 
      --output_test_path output/datasets/test.pt --output_stats_path 
      output/datasets/stats.json --max_seq_length 1024
    deps:
    - path: ../data/selected_validation_pdbs.json
      hash: md5
      md5: f06fbbc1ff58e894ba82ba90774da7af
      size: 5354
    - path: output/test_data/test_filtered.parquet
      hash: md5
      md5: e94468c64a21000dbe2b4080ca8c8309
      size: 4577378
    - path: output/train_data/train_filtered.parquet
      hash: md5
      md5: fa0b6f9781754e248f76df564de64395
      size: 141102795
    - path: src/prepare_dataset.py
      hash: md5
      md5: 7e8c5005093aa0fca56b3f165605955c
      size: 2866
    outs:
    - path: output/datasets/stats.json
      hash: md5
      md5: 9fe010ccb9b15991b30d0d0786147192
      size: 122
    - path: output/datasets/test.pt
      hash: md5
      md5: 92625625842448c8cc76634d0b507931
      size: 677360169
    - path: output/datasets/train.pt
      hash: md5
      md5: 2ba411ecf4fd035b592c6a5388d77640
      size: 18467970557
    - path: output/datasets/val.pt
      hash: md5
      md5: 86a55f5b534d74b75e4b4e92d4b1b2a6
      size: 521479505
  train:
    cmd: python src/train.py --model esm2_unsupervised_baseline --datamodule 
      protein_datamodule --trainer.output_dir output/train_checkpoints 
      --trainer.max_epochs 300 --trainer.log_every_n_steps 10 
      --trainer.accumulate_grad_batches 2 --trainer.val_check_interval 300 
      --trainer.checkpoint.monitor val_precision_long@L/5 
      --trainer.checkpoint.mode max --trainer.checkpoint.save_top_k 1 
      --trainer.early_stopping.monitor val_precision_long@L/5 
      --trainer.early_stopping.patience 10 --trainer.early_stopping.mode max 
      --model._target_ esm2_unsupervised_baseline --model.name 
      esm2_unsupervised_baseline --model.backbone facebook/esm2_t33_650M_UR50D 
      --model.learning_rate 0.005 --model.weight_decay 0.001 
      --datamodule._target_ protein_datamodule --datamodule.name '1 seq from pdb
      except cluster' --datamodule.batch_size 2 --datamodule.num_workers 4 
      --datamodule.max_seq_length 1024 --datamodule.tokenizer_name 
      facebook/esm2_t33_650M_UR50D --datamodule.contact_threshold 8.0 
      --datamodule.train_dataset_path output/datasets/train.pt 
      --datamodule.val_dataset_path output/datasets/val.pt 
      --datamodule.test_dataset_path output/datasets/test.pt 
      --datamodule.sampler.cluster_path output/mmseqs/all_seqs_clust.tsv 
      --datamodule.sampler.train_n_pdb 1.0 --datamodule.sampler.val_n_pdb 1.0 
      --datamodule.sampler.test_n_pdb 1.0 
      --datamodule.sampler.train_max_chains_per_pdb 1 
      --datamodule.sampler.val_max_chains_per_pdb 1
    deps:
    - path: output/datasets/train.pt
      hash: md5
      md5: 2ba411ecf4fd035b592c6a5388d77640
      size: 18467970557
    - path: output/datasets/val.pt
      hash: md5
      md5: 86a55f5b534d74b75e4b4e92d4b1b2a6
      size: 521479505
    outs:
    - path: output/train_checkpoints
      hash: md5
      md5: acf4f4ea5281c62ea63c694c7f737692.dir
      size: 2604663769
      nfiles: 5
  predict@val:
    cmd: python src/predict.py --model esm2_unsupervised_baseline --datamodule 
      protein_datamodule --trainer.output_dir output/train_checkpoints 
      --trainer.max_epochs 300 --trainer.log_every_n_steps 10 
      --trainer.accumulate_grad_batches 2 --trainer.val_check_interval 300 
      --trainer.checkpoint.monitor val_precision_long@L/5 
      --trainer.checkpoint.mode max --trainer.checkpoint.save_top_k 1 
      --trainer.early_stopping.monitor val_precision_long@L/5 
      --trainer.early_stopping.patience 10 --trainer.early_stopping.mode max 
      --model._target_ esm2_unsupervised_baseline --model.name 
      esm2_unsupervised_baseline --model.backbone facebook/esm2_t33_650M_UR50D 
      --model.learning_rate 0.005 --model.weight_decay 0.001 
      --datamodule._target_ protein_datamodule --datamodule.name '1 seq from pdb
      except cluster' --datamodule.batch_size 2 --datamodule.num_workers 4 
      --datamodule.max_seq_length 1024 --datamodule.tokenizer_name 
      facebook/esm2_t33_650M_UR50D --datamodule.contact_threshold 8.0 
      --datamodule.train_dataset_path output/datasets/train.pt 
      --datamodule.val_dataset_path output/datasets/val.pt 
      --datamodule.test_dataset_path output/datasets/val.pt 
      --datamodule.sampler.cluster_path output/mmseqs/all_seqs_clust.tsv 
      --datamodule.sampler.train_n_pdb 1.0 --datamodule.sampler.val_n_pdb 1.0 
      --datamodule.sampler.test_n_pdb 1.0 
      --datamodule.sampler.train_max_chains_per_pdb 1 
      --datamodule.sampler.val_max_chains_per_pdb 1 --checkpoint_name best 
      --output_predictions_path output/predictions/val.pkl
    deps:
    - path: output/datasets/val.pt
      hash: md5
      md5: 86a55f5b534d74b75e4b4e92d4b1b2a6
      size: 521479505
    outs:
    - path: output/predictions/val.pkl
      hash: md5
      md5: be4648673032de2e4a341156e3d3a466
      size: 410625471
  predict@test:
    cmd: python src/predict.py --model esm2_unsupervised_baseline --datamodule 
      protein_datamodule --trainer.output_dir output/train_checkpoints 
      --trainer.max_epochs 300 --trainer.log_every_n_steps 10 
      --trainer.accumulate_grad_batches 2 --trainer.val_check_interval 300 
      --trainer.checkpoint.monitor val_precision_long@L/5 
      --trainer.checkpoint.mode max --trainer.checkpoint.save_top_k 1 
      --trainer.early_stopping.monitor val_precision_long@L/5 
      --trainer.early_stopping.patience 10 --trainer.early_stopping.mode max 
      --model._target_ esm2_unsupervised_baseline --model.name 
      esm2_unsupervised_baseline --model.backbone facebook/esm2_t33_650M_UR50D 
      --model.learning_rate 0.005 --model.weight_decay 0.001 
      --datamodule._target_ protein_datamodule --datamodule.name '1 seq from pdb
      except cluster' --datamodule.batch_size 2 --datamodule.num_workers 4 
      --datamodule.max_seq_length 1024 --datamodule.tokenizer_name 
      facebook/esm2_t33_650M_UR50D --datamodule.contact_threshold 8.0 
      --datamodule.train_dataset_path output/datasets/train.pt 
      --datamodule.val_dataset_path output/datasets/val.pt 
      --datamodule.test_dataset_path output/datasets/test.pt 
      --datamodule.sampler.cluster_path output/mmseqs/all_seqs_clust.tsv 
      --datamodule.sampler.train_n_pdb 1.0 --datamodule.sampler.val_n_pdb 1.0 
      --datamodule.sampler.test_n_pdb 1.0 
      --datamodule.sampler.train_max_chains_per_pdb 1 
      --datamodule.sampler.val_max_chains_per_pdb 1 --checkpoint_name best 
      --output_predictions_path output/predictions/test.pkl
    deps:
    - path: output/datasets/test.pt
      hash: md5
      md5: 92625625842448c8cc76634d0b507931
      size: 677360169
    outs:
    - path: output/predictions/test.pkl
      hash: md5
      md5: c536ca99d568abb18611a4d3fc835bde
      size: 559268155
  evaluate@val:
    cmd: python src/evaluate.py --dataset_path output/datasets/val.pt 
      --predictions_path output/predictions/val.pkl --clusters_path 
      output/mmseqs/all_seqs_clust.tsv --output_dir output/evaluation/val 
      --fixed_visualization_ids train_1YVY_A train_7SV6_A train_2ZCA_B --prefix 
      val --wandb_run_dir output/train_checkpoints/wandb
    deps:
    - path: output/datasets/val.pt
      hash: md5
      md5: 86a55f5b534d74b75e4b4e92d4b1b2a6
      size: 521479505
    - path: output/mmseqs/all_seqs_clust.tsv
      hash: md5
      md5: d3e122bc224fdd80427217d4c2a6309b
      size: 671166
    - path: output/predictions/val.pkl
      hash: md5
      md5: be4648673032de2e4a341156e3d3a466
      size: 410625471
    outs:
    - path: output/evaluation/val
      hash: md5
      md5: ebe8a0296cde232bb6fbbd933a6b9a42.dir
      size: 5793912
      nfiles: 7
  evaluate@test:
    cmd: python src/evaluate.py --dataset_path output/datasets/test.pt 
      --predictions_path output/predictions/test.pkl --clusters_path 
      output/mmseqs/all_seqs_clust.tsv --output_dir output/evaluation/test 
      --prefix test --wandb_run_dir output/train_checkpoints/wandb
    deps:
    - path: output/datasets/test.pt
      hash: md5
      md5: 92625625842448c8cc76634d0b507931
      size: 677360169
    - path: output/mmseqs/all_seqs_clust.tsv
      hash: md5
      md5: d3e122bc224fdd80427217d4c2a6309b
      size: 671166
    - path: output/predictions/test.pkl
      hash: md5
      md5: c536ca99d568abb18611a4d3fc835bde
      size: 559268155
    outs:
    - path: output/evaluation/test
      hash: md5
      md5: f87867d2c345f4716346ddf70ad3db9c.dir
      size: 6470695
      nfiles: 7
